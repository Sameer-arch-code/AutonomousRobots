services:
  iki_ros:
    image: fbe-dockerreg.rwu.de/doz-iki/staehle-vls/amr-tb3:latest
    container_name: iki_ros_container
    network_mode: host
    ipc: host
    privileged: true
    environment:
      DISPLAY: ${DISPLAY}
      ROS_DOMAIN_ID: $ROS_DOMAIN_ID
      ROS_LOCALHOST_ONLY: 0
      TURTLEBOT3_MODEL: burger
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ${HOME}/iki_workspace:/root
    stdin_open: true
    tty: true
    command: >
      bash -c "
        echo 'source /etc/bash.bashrc' > /root/.bashrc &&
        echo 'source /opt/ros/humble/setup.bash' >> /root/.bashrc &&
        echo 'source /usr/share/gazebo/setup.bash' >> /root/.bashrc &&

        echo 'PS1=\"ðŸ¤– IKI_ROS2 | \[\033[1;36m\]\h \[\033[1;34m\]\W\[\033[0;35m\] \[\033[1;36m\]# \[\033[0m\]\"' >> /root/.bashrc &&
        echo '#GENERATED!!!!! DO NOT EDIT THIS FILE!!!!!x' >> /root/.bashrc &&
        chown -R $(id -u) /root &&
        cd /root &&

        echo 'if [ -f \"/root/.my_bashrc\" ]; then
              source /root/.my_bashrc
        else
              echo \"No .my_bashrc found. If you want this warning to go away create an empty file .my_bashrc in your iki_workspace\"
        fi' >> /root/.bashrc &&

        # Install specific setuptools version and rebuild workspace
        python3 -m pip install --upgrade pip && pip install 'setuptools==58.2.0' &&
        rm -rf build install log && colcon build --symlink-install &&

        source /opt/ros/humble/setup.bash &&
        source /usr/share/gazebo/setup.bash &&
        source install/setup.bash &&
        ros2 launch tb3_rwu_arena tb3_sim.launch.py x:=0.82 y:=-1.75 yaw:=0.0 ; exec bash
      "
